#include "fase2.h"

int test_i = 0;
uint16_t local1[BUFFERSIZE];
uint16_t local2[BUFFERSIZE];
int curPkt = 0;
int curData = 1;
/*uint16_t bufferData1[BUFFERSIZE];
uint16_t bufferData2[BUFFERSIZE];
*/

uint8_t poligon1s [4][MAX_TRAMA] = {
			{0x55,0xAA,0x00,0xFF,0x00,0x00,0x80,0x3F,0x00,0x00,0xFE,0x29,0x11,0x2A,0x26,0x2A,0x3C,0x2A,0x53,0x2A,0x6B,0x2A,0x83,0x2A,0x9D,0x2A,0xB7,0x2A,0xD2,0x2A,0xEF,0x2A,0x0C,0x2B,0x2B,0x2B,0x4A,0x2B,0x6B,0x2B,0x8C,0x2B,0xAF,0x2B,0xD2,0x2B,0xF7,0x2B,0x1D,0x2C,0x44,0x2C,0x6C,0x2C,0x95,0x2C,0xBF,0x2C,0xEB,0x2C,0x18,0x2D,0x46,0x2D,0x75,0x2D,0xA6,0x2D,0xD7,0x2D,0x0B,0x2E,0x3F,0x2E,0x75,0x2E,0xAD,0x2E,0xE5,0x2E,0x20,0x2F,0x5B,0x2F,0x99,0x2F,0xD8,0x2F,0x18,0x30,0x5A,0x30,0x9E,0x30,0xE3,0x30,0x2A,0x31,0x73,0x31,0xBE,0x31,0x0B,0x32,0x59,0x32,0xAA,0x32,0xFC,0x32,0x51,0x33,0xA8,0x33,0x01,0x34,0x5C,0x34,0x36,0x34,0xFE,0x33,0xC8,0x33,0x93,0x33,0x60,0x33,0x2E,0x33,0xFD,0x32,0xCE,0x32,0xA0,0x32,0x73,0x32,0x48,0x32,0x1D,0x32,0xF4,0x31,0xCD,0x31,0xA6,0x31,0x81,0x31,0x5D,0x31,0x3A,0x31,0x18,0x31,0xF8,0x30,0xD8,0x30,0xBA,0x30,0x9C,0x30,0x80,0x30,0x65,0x30,0x4B,0x30,0x32,0x30,0x19,0x30,0x02,0x30,0xEC,0x2F,0xD7,0x2F,0xC3,0x2F,0xB0,0x2F,0x9E,0x2F,0x8D,0x2F,0x7D,0x2F,0x6E,0x2F,0x60,0x2F,0x53,0x2F,0x47,0x2F,0x3B,0x2F,0x31,0x2F,0x28,0x2F,0x1F,0x2F,0x18,0x2F,0x11,0x2F,0x0B,0x2F,0x06,0x2F,0x03,0x2F,0x00,0x2F,0xFE,0x2E,0xFD,0x2E,0xFC,0x2E,0xFD,0x2E,0xFF,0x2E,0x01,0x2F,0x05,0x2F,0x09,0x2F,0x0F,0x2F,0x15,0x2F,0x1C,0x2F,0x24,0x2F,0x2D,0x2F,0x37,0x2F,0x42,0x2F,0x4E,0x2F,0x5B,0x2F,0x68,0x2F,0x77,0x2F,0x87,0x2F,0x97,0x2F,0xA9,0x2F,0xBB,0x2F,0xCF,0x2F,0xE4,0x2F,0xF9,0x2F,0x10,0x30,0x27,0x30,0x40,0x30,0x5A,0x30,0x75,0x30,0x90,0x30,0xAD,0x30,0xCB,0x30,0xEA,0x30,0x0B,0x31,0x2C,0x31,0x4E,0x31,0x72,0x31,0x97,0x31,0xBD,0x31,0xE4,0x31,0x0C,0x32,0x36,0x32,0x61,0x32,0x8D,0x32,0xBB,0x32,0xE9,0x32,0x19,0x33,0x4B,0x33,0x7E,0x33,0xB2,0x33,0xE8,0x33,0x1F,0x34,0x58,0x34,0x92,0x34,0xCD,0x34,0x0B,0x35,0x4A,0x35,0x8A,0x35,0xCC,0x35,0x10,0x36,0x56,0x36,0x9D,0x36,0xE6,0x36,0x31,0x37,0x7E,0x37,0xCD,0x37,0x1E,0x38,0x71,0x38,0xC6,0x38,0x1D,0x39,0x76,0x39,0xD2,0x39,0x30,0x3A,0x90,0x3A,0xF2,0x3A,0x57,0x3B,0xBF,0x3B,0x29,0x3C,0x96,0x3C,0x06,0x3D,0x78,0x3D,0xED,0x3D,0x65,0x3E,0x5C,0x3E,0xA0,0x3D,0xEA,0x3C,0x39,0x3C,0x8D,0x3B,0xE6,0x3A,0x44,0x3A,0xA6,0x39,0x0D,0x39,0x78,0x38,0xE7,0x37,0x5A,0x37,0xD1,0x36,0x4C,0x36,0xCA,0x35,0x4B,0x35,0xD0,0x34,0x58,0x34,0xE4,0x33,0x72,0x33,0x03,0x33,0x97,0x32,0x2E,0x32,0xC7,0x31,0x63,0x31,0x01,0x31,0xA2,0x30,0x46,0x30,0xEB,0x2F,0x93,0x2F,0x3D,0x2F,0xE9,0x2E,0x97,0x2E,0x47,0x2E,0xF9,0x2D,0xAD,0x2D,0x63,0x2D,0x1B,0x2D,0xD4,0x2C,0x8F,0x2C,0x4C,0x2C,0x0B,0x2C,0xCB,0x2B,0x8C,0x2B,0x50,0x2B,0x14,0x2B,0xDA,0x2A,0xA2,0x2A,0x6B,0x2A,0x35,0x2A,0x01,0x2A,0xCE,0x29,0x9C,0x29,0x6C,0x29,0x3C,0x29,0x0E,0x29,0xE2,0x28,0xB6,0x28,0x8B,0x28,0x62,0x28,0x3A,0x28,0x13,0x28,0xEC,0x27,0xC7,0x27,0xA3,0x27,0x80,0x27},
			{0x55,0xAA,0xC0,0xFF,0xC0,0x3F,0x40,0x7F,0x00,0x00,0x5E,0x27,0x3D,0x27,0x1D,0x27,0xFE,0x26,0xE0,0x26,0xC3,0x26,0xA7,0x26,0x8C,0x26,0x71,0x26,0x58,0x26,0x3F,0x26,0x27,0x26,0x10,0x26,0xFA,0x25,0xE5,0x25,0xD0,0x25,0xBD,0x25,0xAA,0x25,0x98,0x25,0x87,0x25,0x76,0x25,0x67,0x25,0x58,0x25,0x4A,0x25,0x3C,0x25,0x30,0x25,0x24,0x25,0x19,0x25,0x0F,0x25,0x05,0x25,0xFC,0x24,0xF4,0x24,0xED,0x24,0xE6,0x24,0xE0,0x24,0xDB,0x24,0xD7,0x24,0xD3,0x24,0xD0,0x24,0xCE,0x24,0xCC,0x24,0xCB,0x24,0xCB,0x24,0xCC,0x24,0xCD,0x24,0xCF,0x24,0xD2,0x24,0xD5,0x24,0xD9,0x24,0xDE,0x24,0xE4,0x24,0xEA,0x24,0xF1,0x24,0xF9,0x24,0x02,0x25,0x0B,0x25,0x15,0x25,0x20,0x25,0x2B,0x25,0x38,0x25,0x45,0x25,0x53,0x25,0x61,0x25,0x71,0x25,0x81,0x25,0x92,0x25,0xA3,0x25,0xB6,0x25,0xC9,0x25,0xDD,0x25,0xF2,0x25,0x08,0x26,0x1F,0x26,0x36,0x26,0x4F,0x26,0x68,0x26,0x82,0x26,0x9D,0x26,0xB9,0x26,0xD6,0x26,0xF4,0x26,0x12,0x27,0x32,0x27,0x53,0x27,0x74,0x27,0x97,0x27,0xBA,0x27,0xDF,0x27,0x05,0x28,0x2C,0x28,0x53,0x28,0x7C,0x28,0xA7,0x28,0xD2,0x28,0xFE,0x28,0x2C,0x29,0x5B,0x29,0x8B,0x29,0xBC,0x29,0xEE,0x29,0x22,0x2A,0x57,0x2A,0x8E,0x2A,0xC6,0x2A,0xFF,0x2A,0x3A,0x2B,0x76,0x2B,0xB4,0x2B,0xF4,0x2B,0x35,0x2C,0x77,0x2C,0xBB,0x2C,0x01,0x2D,0x49,0x2D,0x93,0x2D,0xDE,0x2D,0x2B,0x2E,0x7A,0x2E,0xCB,0x2E,0x1F,0x2F,0x74,0x2F,0xCB,0x2F,0x25,0x30,0x81,0x30,0xDF,0x30,0x40,0x31,0xA3,0x31,0x09,0x32,0x71,0x32,0xDC,0x32,0x4A,0x33,0xBB,0x33,0x2E,0x34,0xA5,0x34,0x1F,0x35,0x9C,0x35,0x1D,0x36,0xA1,0x36,0x29,0x37,0xB5,0x37,0x44,0x38,0xD7,0x38,0x6F,0x39,0x0B,0x3A,0xAC,0x3A,0x51,0x3B,0xFB,0x3B,0xAA,0x3C,0x5E,0x3D,0x18,0x3E,0xD7,0x3E,0x9D,0x3F,0x68,0x40,0x3A,0x41,0x13,0x42,0xF3,0x42,0xDA,0x43,0xC9,0x44,0xBF,0x45,0x39,0x45,0x7E,0x44,0xC9,0x43,0x18,0x43,0x6D,0x42,0xC5,0x41,0x23,0x41,0x85,0x40,0xEB,0x3F,0x55,0x3F,0xC3,0x3E,0x35,0x3E,0xAA,0x3D,0x23,0x3D,0xA0,0x3C,0x20,0x3C,0xA3,0x3B,0x29,0x3B,0xB2,0x3A,0x3F,0x3A,0xCE,0x39,0x60,0x39,0xF5,0x38,0x8C,0x38,0x26,0x38,0xC3,0x37,0x62,0x37,0x03,0x37,0xA6,0x36,0x4C,0x36,0xF4,0x35,0x9F,0x35,0x4B,0x35,0xF9,0x34,0xAA,0x34,0x5C,0x34,0x10,0x34,0xC6,0x33,0x7E,0x33,0x37,0x33,0xF3,0x32,0xB0,0x32,0x6F,0x32,0x2F,0x32,0xF1,0x31,0xB4,0x31,0x79,0x31,0x40,0x31,0x08,0x31,0xD1,0x30,0x9C,0x30,0x69,0x30,0x36,0x30,0x05,0x30,0xD5,0x2F,0xA7,0x2F,0x7A,0x2F,0x4E,0x2F,0x23,0x2F,0xFA,0x2E,0xD1,0x2E,0xAA,0x2E,0x84,0x2E,0x60,0x2E,0x3C,0x2E,0x19,0x2E,0xF8,0x2D,0xD8,0x2D,0xB8,0x2D,0x9A,0x2D,0x7D,0x2D,0x61,0x2D,0x45,0x2D,0x2B,0x2D,0x12,0x2D,0xFA,0x2C,0xE3,0x2C,0xCC,0x2C,0xB7,0x2C,0xA3,0x2C,0x8F,0x2C,0x7D,0x2C,0x6B,0x2C,0x5B,0x2C,0x4B,0x2C,0x3C,0x2C,0x2E,0x2C,0x21,0x2C,0x15,0x2C,0x0A,0x2C,0xFF,0x2B,0xF6,0x2B,0xED,0x2B,0xE5,0x2B,0xDF,0x2B,0xD8,0x2B},
			{0x55,0xAA,0x80,0xFF,0x80,0x7F,0x00,0x0B,0x00,0x00,0xD3,0x2B,0xCF,0x2B,0xCC,0x2B,0xC9,0x2B,0xC7,0x2B,0xC6,0x2B,0xC6,0x2B,0xC7,0x2B,0xC9,0x2B,0xCB,0x2B,0xCF,0x2B,0xD3,0x2B,0xD8,0x2B,0xDE,0x2B,0xE5,0x2B,0xEC,0x2B,0xF5,0x2B,0xFE,0x2B,0x09,0x2C,0x14,0x2C,0x20,0x2C,0x2D,0x2C,0x3B,0x2C,0x49,0x2C,0x59,0x2C,0x6A,0x2C,0x7B,0x2C,0x8D,0x2C,0xA1,0x2C,0xB5,0x2C,0xCA,0x2C,0xE0,0x2C,0xF7,0x2C,0x10,0x2D,0x29,0x2D,0x43,0x2D,0x5E,0x2D,0x7A,0x2D,0x97,0x2D,0xB5,0x2D,0xD4,0x2D,0xF5,0x2D,0x16,0x2E,0x38,0x2E,0x5C,0x2E,0x81,0x2E,0xA7,0x2E,0xCE,0x2E,0xF6,0x2E,0x1F,0x2F,0x4A,0x2F,0x75,0x2F,0xA2,0x2F,0xD1,0x2F,0x00,0x30,0x31,0x30,0x63,0x30,0x97,0x30,0xCC,0x30,0x02,0x31,0x3A,0x31,0x74,0x31,0xAE,0x31,0xEB,0x31,0x29,0x32,0x68,0x32,0xA9,0x32,0xEC,0x32,0x31,0x33,0x77,0x33,0xBF,0x33,0x09,0x34,0x54,0x34,0xA2,0x34,0xF1,0x34,0x43,0x35,0x96,0x35,0xEC,0x35,0x43,0x36,0x9D,0x36,0xFA,0x36,0x58,0x37,0xB9,0x37,0x1C,0x38,0x82,0x38,0xEA,0x38,0x55,0x39,0xC3,0x39,0x33,0x3A,0xA7,0x3A,0x1D,0x3B,0x97,0x3B,0x13,0x3C,0xFA,0x3B,0x6D,0x3B,0xE5,0x3A,0x5F,0x3A,0xDE,0x39,0x5F,0x39,0xE4,0x38,0x6C,0x38,0xF7,0x37,0x85,0x37,0x16,0x37,0xA9,0x36,0x40,0x36,0xD9,0x35,0x74,0x35,0x12,0x35,0xB2,0x34,0x55,0x34,0xFA,0x33,0xA1,0x33,0x4B,0x33,0xF6,0x32,0xA4,0x32,0x54,0x32,0x05,0x32,0xB9,0x31,0x6E,0x31,0x25,0x31,0xDE,0x30,0x99,0x30,0x55,0x30,0x13,0x30,0xD3,0x2F,0x94,0x2F,0x57,0x2F,0x1B,0x2F,0xE1,0x2E,0xA8,0x2E,0x71,0x2E,0x3B,0x2E,0x07,0x2E,0xD4,0x2D,0xA2,0x2D,0x72,0x2D,0x42,0x2D,0x14,0x2D,0xE8,0x2C,0xBC,0x2C,0x92,0x2C,0x69,0x2C,0x41,0x2C,0x1A,0x2C,0xF4,0x2B,0xD0,0x2B,0xAC,0x2B,0x8A,0x2B,0x68,0x2B,0x48,0x2B,0x28,0x2B,0x0A,0x2B,0xED,0x2A,0xD0,0x2A,0xB5,0x2A,0x9B,0x2A,0x81,0x2A,0x69,0x2A,0x51,0x2A,0x3B,0x2A,0x25,0x2A,0x10,0x2A,0xFC,0x29,0xE9,0x29,0xD7,0x29,0xC6,0x29,0xB5,0x29,0xA6,0x29,0x97,0x29,0x89,0x29,0x7C,0x29,0x70,0x29,0x65,0x29,0x5A,0x29,0x50,0x29,0x48,0x29,0x40,0x29,0x38,0x29,0x32,0x29,0x2C,0x29,0x28,0x29,0x24,0x29,0x20,0x29,0x1E,0x29,0x1C,0x29,0x1C,0x29,0x1C,0x29,0x1C,0x29,0x1E,0x29,0x21,0x29,0x24,0x29,0x28,0x29,0x2D,0x29,0x32,0x29,0x39,0x29,0x40,0x29,0x48,0x29,0x51,0x29,0x5B,0x29,0x65,0x29,0x71,0x29,0x7D,0x29,0x8A,0x29,0x98,0x29,0xA7,0x29,0xB6,0x29,0xC7,0x29,0xD8,0x29,0xEA,0x29,0xFE,0x29,0x11,0x2A,0x26,0x2A,0x3C,0x2A,0x53,0x2A,0x6B,0x2A,0x83,0x2A,0x9D,0x2A,0xB7,0x2A,0xD2,0x2A,0xEF,0x2A,0x0C,0x2B,0x2B,0x2B,0x4A,0x2B,0x6B,0x2B,0x8C,0x2B,0xAF,0x2B,0xD2,0x2B,0xF7,0x2B,0x1D,0x2C,0x44,0x2C,0x6C,0x2C,0x95,0x2C,0xBF,0x2C,0xEB,0x2C,0x18,0x2D,0x46,0x2D,0x75,0x2D,0xA6,0x2D,0xD7,0x2D,0x0B,0x2E,0x3F,0x2E,0x75,0x2E,0xAD,0x2E,0xE5,0x2E,0x20,0x2F,0x5B,0x2F,0x99,0x2F,0xD8,0x2F,0x18,0x30,0x5A,0x30,0x9E,0x30,0xE3,0x30,0x2A,0x31,0x73,0x31},
			{0x55,0xAA,0x40,0xFF,0x40,0x0B,0xC0,0x4A,0x00,0x00,0xBE,0x31,0x0B,0x32,0x59,0x32,0xAA,0x32,0xFC,0x32,0x51,0x33,0xA8,0x33,0x01,0x34,0x5C,0x34,0x36,0x34,0xFE,0x33,0xC8,0x33,0x93,0x33,0x60,0x33,0x2E,0x33,0xFD,0x32,0xCE,0x32,0xA0,0x32,0x73,0x32,0x48,0x32,0x1D,0x32,0xF4,0x31,0xCD,0x31,0xA6,0x31,0x81,0x31,0x5D,0x31,0x3A,0x31,0x18,0x31,0xF8,0x30,0xD8,0x30,0xBA,0x30,0x9C,0x30,0x80,0x30,0x65,0x30,0x4B,0x30,0x32,0x30,0x19,0x30,0x02,0x30,0xEC,0x2F,0xD7,0x2F,0xC3,0x2F,0xB0,0x2F,0x9E,0x2F,0x8D,0x2F,0x7D,0x2F,0x6E,0x2F,0x60,0x2F,0x53,0x2F,0x47,0x2F,0x3B,0x2F,0x31,0x2F,0x28,0x2F,0x1F,0x2F,0x18,0x2F,0x11,0x2F,0x0B,0x2F,0x06,0x2F,0x03,0x2F,0x00,0x2F,0xFE,0x2E,0xFD,0x2E,0xFC,0x2E,0xFD,0x2E,0xFF,0x2E,0x01,0x2F,0x05,0x2F,0x09,0x2F,0x0F,0x2F,0x15,0x2F,0x1C,0x2F,0x24,0x2F,0x2D,0x2F,0x37,0x2F,0x42,0x2F,0x4E,0x2F,0x5B,0x2F,0x68,0x2F,0x77,0x2F,0x87,0x2F,0x97,0x2F,0xA9,0x2F,0xBB,0x2F,0xCF,0x2F,0xE4,0x2F,0xF9,0x2F,0x10,0x30,0x27,0x30,0x40,0x30,0x5A,0x30,0x75,0x30,0x90,0x30,0xAD,0x30,0xCB,0x30,0xEA,0x30,0x0B,0x31,0x2C,0x31,0x4E,0x31,0x72,0x31,0x97,0x31,0xBD,0x31,0xE4,0x31,0x0C,0x32,0x36,0x32,0x61,0x32,0x8D,0x32,0xBB,0x32,0xE9,0x32,0x19,0x33,0x4B,0x33,0x7E,0x33,0xB2,0x33,0xE8,0x33,0x1F,0x34,0x58,0x34,0x92,0x34,0xCD,0x34,0x0B,0x35,0x4A,0x35,0x8A,0x35,0xCC,0x35,0x10,0x36,0x56,0x36,0x9D,0x36,0xE6,0x36,0x31,0x37,0x7E,0x37,0xCD,0x37,0x1E,0x38,0x71,0x38,0xC6,0x38,0x1D,0x39,0x76,0x39,0xD2,0x39,0x30,0x3A,0x90,0x3A,0xF2,0x3A,0x57,0x3B,0xBF,0x3B,0x29,0x3C,0x96,0x3C,0x06,0x3D,0x78,0x3D,0xED,0x3D,0x65,0x3E,0x5C,0x3E,0xA0,0x3D,0xEA,0x3C,0x39,0x3C,0x8D,0x3B,0xE6,0x3A,0x44,0x3A,0xA6,0x39,0x0D,0x39,0x78,0x38,0xE7,0x37,0x5A,0x37,0xD1,0x36,0x4C,0x36,0xCA,0x35,0x4B,0x35,0xD0,0x34,0x58,0x34,0xE4,0x33,0x72,0x33,0x03,0x33,0x97,0x32,0x2E,0x32,0xC7,0x31,0x63,0x31,0x01,0x31,0xA2,0x30,0x46,0x30,0xEB,0x2F,0x93,0x2F,0x3D,0x2F,0xE9,0x2E,0x97,0x2E,0x47,0x2E,0xF9,0x2D,0xAD,0x2D,0x63,0x2D,0x1B,0x2D,0xD4,0x2C,0x8F,0x2C,0x4C,0x2C,0x0B,0x2C,0xCB,0x2B,0x8C,0x2B,0x50,0x2B,0x14,0x2B,0xDA,0x2A,0xA2,0x2A,0x6B,0x2A,0x35,0x2A,0x01,0x2A,0xCE,0x29,0x9C,0x29,0x6C,0x29,0x3C,0x29,0x0E,0x29,0xE2,0x28,0xB6,0x28,0x8B,0x28,0x62,0x28,0x3A,0x28,0x13,0x28,0xEC,0x27,0xC7,0x27,0xA3,0x27,0x80,0x27,0x5E,0x27,0x3D,0x27,0x1D,0x27,0xFE,0x26,0xE0,0x26,0xC3,0x26,0xA7,0x26,0x8C,0x26,0x71,0x26,0x58,0x26,0x3F,0x26,0x27,0x26,0x10,0x26,0xFA,0x25,0xE5,0x25,0xD0,0x25,0xBD,0x25,0xAA,0x25,0x98,0x25,0x87,0x25,0x76,0x25,0x67,0x25,0x58,0x25,0x4A,0x25,0x3C,0x25,0x30,0x25,0x24,0x25,0x19,0x25,0x0F,0x25,0x05,0x25,0xFC,0x24,0xF4,0x24,0xED,0x24,0xE6,0x24,0xE0,0x24,0xDB,0x24,0xD7,0x24,0xD3,0x24,0xD0,0x24,0xCE,0x24,0xCC,0x24,0xCB,0x24,0xCB,0x24,0xCC,0x24,0xCD,0x24}
	};

void InitializeDMA(uint16_t localx[BUFFERSIZE],uint16_t bufferDatax[BUFFERSIZE]){
	GPIO_InitTypeDef GPIO_InitStructure;
	NVIC_InitTypeDef NVIC_InitStructure;

	DMA_InitTypeDef DMA_InitStructure;

	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOF, ENABLE);

	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6 | GPIO_Pin_7;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AN;
	GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;

	GPIO_Init(GPIOF, &GPIO_InitStructure);
	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_DMA2, ENABLE);

	DMA_InitStructure.DMA_Channel = DMA_Channel_2;
	DMA_InitStructure.DMA_PeripheralBaseAddr = (uint32_t) localx; //En comptes de fer aixo, guardar-ho tot el que es repo de la USART en un array i ho passes aqui
	DMA_InitStructure.DMA_Memory0BaseAddr = (uint32_t) bufferDatax;
	DMA_InitStructure.DMA_DIR = DMA_DIR_MemoryToMemory;
	DMA_InitStructure.DMA_BufferSize = (uint32_t) BUFFERSIZE;
	DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Enable; //Disable si fem usart
	DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Enable;
	DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_HalfWord;
	DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_HalfWord;
	DMA_InitStructure.DMA_Mode = DMA_Mode_Normal;
	DMA_InitStructure.DMA_Priority = DMA_Priority_High;
	DMA_InitStructure.DMA_FIFOMode = DMA_FIFOMode_Disable;
	DMA_InitStructure.DMA_FIFOThreshold = DMA_FIFOThreshold_HalfFull;
	DMA_InitStructure.DMA_MemoryBurst = DMA_MemoryBurst_Single;
	DMA_InitStructure.DMA_PeripheralBurst = DMA_PeripheralBurst_Single;

	DMA_Init(DMA2_Stream0, &DMA_InitStructure);
	DMA_Cmd(DMA2_Stream0, DISABLE);

	DMA_ITConfig(DMA2_Stream0, DMA_IT_TC, ENABLE);

	NVIC_InitStructure.NVIC_IRQChannel = DMA2_Stream0_IRQn;;
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
	NVIC_Init(&NVIC_InitStructure);
}

void InitializeDMA_MemToMem(void){
	NVIC_InitTypeDef NVIC_InitStructure;
	DMA_InitTypeDef DMA_InitStructure;

	DMA_InitStructure.DMA_Channel = DMA_Channel_1;
	DMA_InitStructure.DMA_PeripheralBaseAddr = (uint32_t) bufferData1;
	DMA_InitStructure.DMA_Memory0BaseAddr = (uint32_t) bufferData2;
	DMA_InitStructure.DMA_DIR = DMA_DIR_MemoryToMemory;
	DMA_InitStructure.DMA_BufferSize = (uint32_t) BUFFERSIZE;
	DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Enable;
	DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Enable;
	DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_HalfWord;
	DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_HalfWord;
	DMA_InitStructure.DMA_Mode = DMA_Mode_Normal; //TODO: aixo no pot ser circular, ha de ser normal
	DMA_InitStructure.DMA_Priority = DMA_Priority_High;
	DMA_InitStructure.DMA_FIFOMode = DMA_FIFOMode_Disable;
	DMA_InitStructure.DMA_FIFOThreshold = DMA_FIFOThreshold_HalfFull;
	DMA_InitStructure.DMA_MemoryBurst = DMA_MemoryBurst_Single;
	DMA_InitStructure.DMA_PeripheralBurst = DMA_PeripheralBurst_Single;

	DMA_Init(DMA2_Stream1, &DMA_InitStructure);
	DMA_ITConfig(DMA2_Stream1, DMA_IT_TC, ENABLE);

	NVIC_InitStructure.NVIC_IRQChannel = DMA2_Stream1_IRQn;
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;

	NVIC_Init(&NVIC_InitStructure);
	DMA_Cmd(DMA2_Stream1, ENABLE);
}

//Metode interruptiu de la DMA
void DMA2_Stream1_IRQHandler(void) {
 	if (DMA_GetITStatus(DMA2_Stream1, DMA_IT_TCIF1) != RESET) {
 		GPIO_ToggleBits(GPIOE, GPIO_Pin_10);
 		DMA_Cmd(DMA2_Stream1, DISABLE);
 		DMA_ClearITPendingBit(DMA2_Stream1, DMA_IT_TCIF1);
 		test_i = 0;
 	}
 	if(DMA_GetITStatus(DMA2_Stream0, DMA_IT_TCIF0)){
		/* Clear DMA Stream Transfer Complete interrupt pending bit */
		DMA_ClearITPendingBit(DMA2_Stream0, DMA_IT_TCIF0);
		DMA_Cmd(DMA2_Stream1, DISABLE);
		InitializeDMA(local2,bufferData2);
		// Add code here to process buffer
	}
}

void DMA2_Stream0_IRQHandler(void){
	/* Test on DMA Stream Transfer Complete interrupt */
	if(DMA_GetITStatus(DMA2_Stream0, DMA_IT_TCIF0)){
		/* Clear DMA Stream Transfer Complete interrupt pending bit */
		DMA_ClearITPendingBit(DMA2_Stream0, DMA_IT_TCIF0);
		DMA_Cmd(DMA2_Stream0, DISABLE);

		// Se acaba de llenar un buffer con nuevos datos, iniciar el proceso de printado.
		if(currentBuffer==1){
			startPrinting(currentBuffer);
			InitializeDMA(local1,bufferData1);
		} else {
			startPrinting(currentBuffer);
			InitializeDMA(local2,bufferData2);
		}
		if(DMA_GetITStatus(DMA2_Stream0, DMA_IT_DMEIF0) == SET && DMA_GetITStatus(DMA2_Stream0, DMA_IT_FEIF0) == SET) {
			//Error
			DMA_ClearITPendingBit(DMA2_Stream0, DMA_IT_DMEIF0);
			DMA_ClearITPendingBit(DMA2_Stream0, DMA_IT_FEIF0);

		}
	}
}

void InitializeUSART1(void){
	GPIO_InitTypeDef GPIO_InitStruct;
	USART_InitTypeDef USART_InitStruct;
	NVIC_InitTypeDef NVIC_InitStruct;

	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOA, ENABLE);

	GPIO_PinAFConfig(GPIOA, GPIO_PinSource9, GPIO_AF_USART1);
	GPIO_PinAFConfig(GPIOA, GPIO_PinSource10, GPIO_AF_USART1);

	GPIO_InitStruct.GPIO_Pin = GPIO_Pin_9 | GPIO_Pin_10;
	GPIO_InitStruct.GPIO_Mode = GPIO_Mode_AF;
	GPIO_InitStruct.GPIO_OType = GPIO_OType_PP;
	GPIO_InitStruct.GPIO_PuPd = GPIO_PuPd_UP;
	GPIO_InitStruct.GPIO_Speed = GPIO_Speed_100MHz;
	GPIO_Init(GPIOA, &GPIO_InitStruct);

	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1, ENABLE);

	USART_InitStruct.USART_BaudRate = 128000;
	USART_InitStruct.USART_HardwareFlowControl = USART_HardwareFlowControl_None;
	USART_InitStruct.USART_Mode = USART_Mode_Tx | USART_Mode_Rx;
	USART_InitStruct.USART_Parity = USART_Parity_No;
	USART_InitStruct.USART_StopBits = USART_StopBits_1;
	USART_InitStruct.USART_WordLength = USART_WordLength_8b;
	USART_Init(USART1, &USART_InitStruct);
	USART_Cmd(USART1, ENABLE);

	USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);

	NVIC_InitStruct.NVIC_IRQChannel = USART1_IRQn;
	NVIC_InitStruct.NVIC_IRQChannelCmd = ENABLE;
	NVIC_InitStruct.NVIC_IRQChannelPreemptionPriority = 0;
	NVIC_InitStruct.NVIC_IRQChannelSubPriority = 0;
	NVIC_Init(&NVIC_InitStruct);

}

void InitializeUSART2(void){
	GPIO_InitTypeDef GPIO_InitStruct;
	USART_InitTypeDef USART_InitStruct;

	RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOA, ENABLE);

	GPIO_PinAFConfig(GPIOA, GPIO_PinSource2, GPIO_AF_USART2);
	GPIO_PinAFConfig(GPIOA, GPIO_PinSource3, GPIO_AF_USART2);

	GPIO_InitStruct.GPIO_Pin = GPIO_Pin_2 | GPIO_Pin_3;
	GPIO_InitStruct.GPIO_Mode = GPIO_Mode_AF;
	GPIO_InitStruct.GPIO_OType = GPIO_OType_PP;
	GPIO_InitStruct.GPIO_PuPd = GPIO_PuPd_UP;
	GPIO_InitStruct.GPIO_Speed = GPIO_Speed_100MHz;
	GPIO_Init(GPIOA, &GPIO_InitStruct);

	RCC_APB1PeriphClockCmd(RCC_APB1Periph_USART2, ENABLE);

	USART_InitStruct.USART_BaudRate = 128000;
	USART_InitStruct.USART_HardwareFlowControl = USART_HardwareFlowControl_None;
	USART_InitStruct.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;
	USART_InitStruct.USART_Parity = USART_Parity_No;
	USART_InitStruct.USART_StopBits = USART_StopBits_1;
	USART_InitStruct.USART_WordLength = USART_WordLength_8b;
	USART_Init(USART2, &USART_InitStruct);
	USART_Cmd(USART2, ENABLE);

	USART_ITConfig(USART2, USART_IT_RXNE, ENABLE);

}

void fnc_sendUSART(USART_TypeDef *USARTx, uint8_t poligon1 [MAX_TRAMA]) //
{
	//return;
	for(int i = 0; i < MAX_TRAMA;i++) //do it for all characters
	{
		//Check the USASRT modul is avail, if we do not check our data will be disturbed
		while( !(USARTx ->SR & 0x00000040) ){}

		USART_SendData(USARTx, poligon1[i]); //send a character
		 //go the next character

	}
}

int start = 0;
uint16_t sneakPeak[2];
void USART1_IRQHandler(void){

    if(USART_GetITStatus(USART1, USART_IT_RXNE) != RESET){
    	uint16_t chare = USART_ReceiveData(USART1);
    	if(currentBuffer == 1){
    		// Codigo replicado para ambos casos (buffer 1 y 2). Solo se guardarán en el buffer los datos recibidos después de un 0x55AA.
    		if(start == 2){
				if(sneakPeak[0] == 0x55 && sneakPeak[1] == 0xAA){
					start = 3;
					local1[0] = 0x55;
					local1[1] = 0xAA;
					local1[2] = chare;
					test_i = 3;
					return;
				} else {
					start = 0;
					return;
				}
			}
			if(start != 3){
				sneakPeak[start] = chare;
				start++;
				return;
			}
    		// Guardar el valor recibido en el buffer y comprobar si éste está lleno.
			local1[test_i] = chare;
			test_i++;
			if(test_i==BUFFERSIZE){
				DMA_Cmd(DMA2_Stream0, ENABLE);
				currentBuffer = 2;
				test_i=0;
				start = 0;
			}
    	} else {
    		if(start == 2){
				if(sneakPeak[0] == 0x55 && sneakPeak[1] == 0xAA){
					start = 3;
					local2[0] = 0x55;
					local2[1] = 0xAA;
					local2[2] = chare;
					test_i = 3;
					return;
				} else {
					start = 0;
					return;
				}
			}
			if(start != 3){
				sneakPeak[start] = chare;
				start++;
				return;
			}
    		local2[test_i] = chare;
    		//sprintf(&local2[test_i],"%02X",chare);
			test_i++;
			if(test_i==BUFFERSIZE){
				DMA_Cmd(DMA2_Stream0, ENABLE);
				currentBuffer = 1;
				test_i=0;
				start = 0;
			}
    	}
    	//USART_SendData(USART1, 'X');
    	/*USART_SendData(USART1, poligon1s[curPkt][curData]);
    	curData++;
    	if(curData == MAX_TRAMA){
    		curData = 0;
    		curPkt++;
    		if(curPkt == 4){
    			curPkt = 0;
    		}
    	}*/
    }
}

void InitializeDMA1(void){
	InitializeDMA(local2,bufferData2);
}

